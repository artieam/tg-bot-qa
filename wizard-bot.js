const { Telegraf, Scenes, session } = require("telegraf");
const fetch = require("node-fetch");

const stage = new Scenes.Stage([]);

const bot = new Telegraf("<TG_TOKEN>");

bot.use(session());
bot.use(stage.middleware());

bot.telegram.setMyCommands([
    {
        command: "start",
        description: "–°—Ç–∞—Ä—Ç—É–µ–º –±–æ—Ç–∞ - –Ω–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ",
    },
    {
        command: "end",
        description: "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç ‚Äì –í–Ω–∏–º–∞–Ω–∏–µ! —Å—Ç–∏—Ä–∞–µ—Ç –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è",
    },
]);

bot.start(async (ctx) => {
    ctx.session.cnt = 0;
    ctx.session.result = -1;
    const e = await saveUserData(ctx);
    return ctx.reply(
        `–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, ${
            ctx.from.first_name ? ctx.from.first_name : "—Ö–æ—Ä–æ—à–∏–π —á–µ–ª–æ–≤–µ–∫"
        }!\n\nTEST1`
    );
});

bot.command("whoami", async (ctx) => {
    const {id, username, first_name, last_name} = ctx.from;
    return ctx.replyWithMarkdown(
        `–ö—Ç–æ —Ç—ã –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–º–µ:
        *id* : ${id}
        *username* : ${username}
        *–ò–º—è* : ${first_name}
        *–§–∞–º–∏–ª–∏—è* : ${last_name}
        *chatId* : ${ctx.chat.id}`);
});

// bot.on("text", async (ctx) => {
//     const res = await getUserResult(ctx);
//     ctx.session.cnt = res.step;
//     ctx.session.result = res.result;
//
//     if (ctx.session.cnt == "undefined") {
//         ctx.session.cnt = -1;
//         ctx.session.result = -1;
//         const e = await saveUserData(ctx);
//         return ctx.reply("–û–®–ò–ë–ö–ê!!");
//     } else if (ctx.session.cnt == -1) {
//         ctx.session.result = -1;
//         const e = await saveUserData(ctx);
//     } else if (ctx.session.cnt == 0) {
//         let message = "–û—Ç–ª–∏—á–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º!\n\n" +
//             "–ó–∞–¥–∞—á–∞ 1 –∏–∑ 10\n" +
//             "\n" +
//             "–ü—Ä–∏ —Å–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —á–∏—Å–µ–ª –¥–∂—É–Ω –¥–æ–ø—É—Å—Ç–∏–ª —Å–ª–µ–¥—É—é—â–∏–µ –æ—à–∏–±–∫–∏: \n" +
//             "—Ü–∏—Ñ—Ä—É –µ–¥–∏–Ω–∏—Ü `2` –æ–Ω –ø—Ä–∏–Ω—è–ª –∑–∞ `9` –∏ —Ü–∏—Ñ—Ä—É –¥–µ—Å—è—Ç–∫–æ–≤ `4` –ø—Ä–∏–Ω—è–ª –∑–∞ `7`. –í —Å—É–º–º–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å 750. \n" +
//             "–†–∞—Å—Å—á–∏—Ç–∞–π –≤–µ—Ä–Ω—É—é —Å—É–º–º—É."
//         let step = subjectStep(ctx, "start", "–ù–µ–≤–µ—Ä–Ω–æ -- –Ω–∞–ø–∏—à–∏ `start`", message, false);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 1) {
//         let message = "–ó–∞–¥–∞—á–∞ 2 –∏–∑ 10\n" +
//           "\n" +
//           "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –í–∞—Å—è —Ä–µ—à–∏–ª —Å–º–µ–Ω–∏—Ç—å —Ä–∞–±–æ—Ç—É, –ø–æ—Ç–æ–º—É —á—Ç–æ –µ–≥–æ –Ω–µ —É—Å—Ç—Ä–∞–∏–≤–∞–ª–∞ –∑–∞—Ä–ø–ª–∞—Ç–∞. –ù–∞ —Å–æ–±–µ—Å–µ–¥–æ–≤–∞–Ω–∏–∏ –í–∞—Å—è –∑–∞–ø—Ä–æ—Å–∏–ª 185 000 —Ä—É–±–ª–µ–π, —á—Ç–æ –Ω–∞ 25% –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–π –∑–∞—Ä–ø–ª–∞—Ç—ã. \n" +
//           "–°–∫–æ–ª—å–∫–æ –í–∞—Å—è –ø–æ–ª—É—á–∞–µ—Ç —Å–µ–π—á–∞—Å?"
//         let step = subjectStep(ctx, "713", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 2) {
//         let message = "–ó–∞–¥–∞—á–∞ 3 –∏–∑ 10\n" +
//            "\n" +
//            "–ó–∞–ø–∏—Å–∞—Ç—å —á–∏—Å–ª–æ 16 —Å –ø–æ–º–æ—â—å—é —á–µ—Ç—ã—Ä–µ—Ö –ø—è—Ç–µ—Ä–æ–∫ (5), –∏—Å–ø–æ–ª—å–∑—É—è –∞—Ä–∏—Ñ–º–µ—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞–∫–∏ (+,-,*,/).\n" +
//            "–í–≤–µ–¥–∏ –æ—Ç–≤–µ—Ç –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä: 777-77*7+7/777"
//         let step = subjectStep(ctx, "148000", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 3) {
//         let message = "–ó–∞–¥–∞—á–∞ 4 –∏–∑ 10\n" +
//            "\n" +
//            "–í —Å–ø—Ä–∏–Ω—Ç –ø–æ–ø–∞–ª–æ 17 –∑–∞–¥–∞—á. –ú–∏—à–∞ –≤—ã–ø–æ–ª–Ω–∏–ª –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ, —á–µ–º –ú–∞—à–∞, –∞ –ü–µ—Ç—è –±–æ–ª—å—à–µ –ú–∞—à–∏, –Ω–æ –º–µ–Ω—å—à–µ –ú–∏—à–∏. \n" +
//            "–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–∏–ª –ü–µ—Ç—è?"
//         let step = subjectStep(ctx, "55/5+5", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 4) {
//         let message = "–ó–∞–¥–∞—á–∞ 5 –∏–∑ 10\n" +
//           "\n" +
//           "–ü–æ–¥—Ä—è–¥—á–∏–∫ –Ω–∞ –∞—É—Ç—Å–æ—Ä—Å–µ –æ—Ü–µ–Ω–∏–ª –≤–µ—Ä—Å—Ç–∫—É –¥–µ–≤—è—Ç–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü –Ω–∞ —Å–∞–π—Ç–µ –º–µ–Ω—å—à–µ —á–µ–º –≤ 1000 —á–µ–ª–æ–≤–µ–∫–æ-—á–∞—Å–æ–≤, –∞ –≤–µ—Ä—Å—Ç–∫—É –¥–µ—Å—è—Ç–∏ –∞–±—Å–æ–ª—é—Ç–Ω–æ —Ç–∞–∫–∏—Ö –∂–µ —Ç–∞–±–ª–∏—Ü –±–æ–ª–µ–µ —á–µ–º –≤ 1100 —á–µ–ª–æ–≤–µ–∫–æ-—á–∞—Å–æ–≤.  –ï—Å—Ç—å –∏–Ω—Å–∞–π–¥–µ—Ä—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è, —á—Ç–æ –≤–µ—Ä—Å—Ç–∫–∞ –æ–¥–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –∑–∞–Ω–∏–º–∞–µ—Ç —Ü–µ–ª–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–∞—Å–æ–≤. \n" +
//           "–í–æ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –ø–æ–¥—Ä—è–¥—á–∏–∫ –æ—Ü–µ–Ω–∏–ª –≤–µ—Ä—Å—Ç–∫—É –æ–¥–Ω–æ–π —Ç–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü—ã? –í –æ—Ç–≤–µ—Ç–µ –≤–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ."
//         let step = subjectStep(ctx, "5", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 5) {
//         let message = "–ó–∞–¥–∞—á–∞ 6 –∏–∑ 10\n" +
//           "\n" +
//           "–ü–æ–ª—Ç–æ—Ä–∞ —Ä–µ–∫—Ä—É—Ç–µ—Ä–∞ –∑–∞ –ø–æ–ª—Ç–æ—Ä–∞ –º–µ—Å—è—Ü–∞ –Ω–∞—Ö–æ–¥—è—Ç –ø–æ–ª—Ç–æ—Ä–∞ —Å–∏–Ω–∏–æ—Ä–∞. –°–∫–æ–ª—å–∫–æ —Å–∏–Ω–∏–æ—Ä–æ–≤ –Ω–∞–π–¥—É—Ç 9 —Ä–µ–∫—Ä—É—Ç–µ—Ä–æ–≤ –∑–∞ 9 –º–µ—Å—è—Ü–µ–≤?\n" +
//           "–í –æ—Ç–≤–µ—Ç–µ –≤–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ."
//         let step = subjectStep(ctx, "111", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 6) {
//         let message = "–ó–∞–¥–∞—á–∞ 7 –∏–∑ 10\n" +
//           "\n" +
//           "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ –∞—É—Ç—Å–æ—Ä—Å–µ. –û–Ω —Ö–æ—Ç–µ–ª –ø–æ–ª—É—á–∞—Ç—å 1 000 —Ä—É–±–ª–µ–π –≤ —á–∞—Å, –Ω–æ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å —Å–æ–º–Ω–µ–≤–∞–ª—Å—è –≤ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è—Ö –∏ –ø—Ä–µ–¥–ª–æ–∂–∏–ª —Ç–∞–∫—É—é —Å—Ö–µ–º—É:\n" +
//           "- –ó–∞ –∫–∞–∂–¥—É—é –∑–∞–¥–∞—á—É, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –≤ —Å—Ä–æ–∫, –µ–º—É –ø–ª–∞—Ç—è—Ç 1 000 —Ä—É–±–ª–µ–π;\n" +
//           "- –∑–∞ –∫–∞–∂–¥—É—é –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—É—é –∑–∞–¥–∞—á—É –∏–∑ –µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—á–∏—Ç–∞—é—Ç 1 500 —Ä—É–±–ª–µ–π;\n" +
//           "- –≤—ã–ø–ª–∞—Ç–∞ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∑–∞ –∫–∞–∂–¥—ã–µ 30 –∑–∞–¥–∞—á.\n" +
//           "\n" +
//           "–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–ø–æ–ª–Ω–∏–ª 30 –∑–∞–¥–∞—á –∏ –ø–æ–ø—Ä–æ—Å–∏–ª —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å—Å—è. –ï–º—É —Å–∫–∞–∑–∞–ª–∏, —á—Ç–æ –µ–º—É –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–Ω—ã ‚Äî –≤—Å—è —Å—É–º–º–∞ —É—à–ª–∞ –Ω–∞ —à—Ç—Ä–∞—Ñ—ã. \n" +
//           "–°–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å—Ä–æ—á–∏–ª? –í –æ—Ç–≤–µ—Ç–µ –≤–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ."
//         let step = subjectStep(ctx, "54", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 7) {
//         let message = "–ó–∞–¥–∞—á–∞ 8 –∏–∑ 10\n" +
//             "\n" +
//             "–ö–∞—Ä–ª –∏ –ö–ª–∞—Ä–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ –±–æ–ª—å—à–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –æ–¥–Ω–æ–º –±–∏–∑–Ω–µ—Å-—Ü–µ–Ω—Ç—Ä–µ. –ö–ª–∞—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 12 —ç—Ç–∞–∂–µ–π –≤—ã—à–µ. –û–¥–Ω–∞–∂–¥—ã –ö–∞—Ä–ª —Ä–µ—à–∏–ª –ø–æ–¥–Ω—è—Ç—å—Å—è –∫ –ö–ª–∞—Ä–µ –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è –∑–∞–¥–∞—á–∏. –ü—Ä–æ–π–¥—è –ø–æ–ª–æ–≤–∏–Ω—É –ø—É—Ç–∏, –æ–Ω –æ–∫–∞–∑–∞–ª—Å—è –Ω–∞ 8 —ç—Ç–∞–∂–µ. \n" +
//             "–ù–∞ –∫–∞–∫–æ–º —ç—Ç–∞–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ö–ª–∞—Ä–∞?"
//         let step = subjectStep(ctx, "12", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 8) {
//         let message = "–ó–∞–¥–∞—á–∞ 9 –∏–∑ 10\n" +
//             "\n" +
//             "–£ –ë–∏–±—ã –∏ –ë–æ–±—ã –≤ —Å–ø—Ä–∏–Ω—Ç–µ —Å—Ç–æ—è—Ç –∑–∞–¥–∞—á–∏. –ö–∞–∂–¥–∞—è –∏–∑ –Ω–∏—Ö –æ—Ü–µ–Ω–µ–Ω–∞ –≤ 1, 3, 5 –∏–ª–∏ 7 —á–∞—Å–æ–≤. –°—É–º–º–∞—Ä–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∑–∞–¥–∞—á –≤ —Å–ø—Ä–∏–Ω—Ç–µ —É –ë–∏–±—ã –∏ –ë–æ–±—ã –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è. –ü—Ä–∏ —ç—Ç–æ–º —É –ë–∏–±—ã 1-—á–∞—Å–æ–≤—ã—Ö –∑–∞–¥–∞—á —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ —É –ë–æ–±—ã 3-—á–∞—Å–æ–≤—ã—Ö, 3-—á–∞—Å–æ–≤—ã—Ö ‚Äî —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ —É –ë–æ–±—ã 5-—á–∞—Å–æ–≤—ã—Ö, 5-—á–∞—Å–æ–≤—ã—Ö ‚Äî —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ —É –ë–æ–±—ã 7-—á–∞—Å–æ–≤—ã—Ö, –∞ 7-—á–∞—Å–æ–≤—ã—Ö ‚Äî —Å—Ç–æ–ª—å–∫–æ –∂–µ, —Å–∫–æ–ª—å–∫–æ —É –ë–æ–±—ã 1-—á–∞—Å–æ–≤—ã—Ö.\n" +
//             "–û–ø—Ä–µ–¥–µ–ª–∏ —Å–∫–æ–ª—å–∫–æ —É –ë–∏–±—ã 7-—á–∞—Å–æ–≤—ã—Ö –∑–∞–¥–∞—á, –µ—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ, —á—Ç–æ —É –∫–∞–∂–¥–æ–≥–æ –ø–æ 20 –∑–∞–¥–∞—á –≤ —Å–ø—Ä–∏–Ω—Ç–µ."
//         let step = subjectStep(ctx, "14", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 9) {
//         let message = "–ó–∞–¥–∞—á–∞ 10 –∏–∑ 10\n" +
//             "\n" +
//             "–ß–µ—Ç—ã—Ä–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ä–µ—à–∞—é—Ç –∑–∞–¥–∞—á–∏ –≤–º–µ—Å—Ç–µ: –æ–¥–∏–Ω –ø–∏—à–µ—Ç –∫–æ–¥, –∞ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ç—Ä–∏ —Ö–æ—Ä–æ–º –¥–∏–∫—Ç—É—é—Ç. –û–∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ –†–∞–¥–∂–µ—à –¥–∏–∫—Ç–æ–≤–∞–ª –∫–æ–¥ –º–µ–Ω—å—à–µ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö ‚Äî –≤ –ø—è—Ç–∏ –∑–∞–¥–∞—á–∞—Ö. –ê –ú–∞—Ö–∞—Ç–º–∞ –¥–∏–∫—Ç–æ–≤–∞–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö ‚Äî –≤ –≤–æ—Å—å–º–∏ –∑–∞–¥–∞—á–∞—Ö. \n" +
//             "–°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ –∑–∞–¥–∞—á —Ä–µ—à–∏–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏? –í –æ—Ç–≤–µ—Ç–µ –≤–≤–µ–¥–∏ —Ç–æ–ª—å–∫–æ —á–∏—Å–ª–æ."
//         let step = subjectStep(ctx, "5", "–ù–µ–≤–µ—Ä–Ω–æ", message, true);
//         const e = await saveUserData(ctx);
//         return step;
//     } else if (ctx.session.cnt == 10) {
//         const tmpResult = ctx.session.result;
//         let error = "";
//         let step = subjectStep(ctx, "9", error, ``, true);
//         if (ctx.session.result == tmpResult) {
//             error = "–ù–µ–≤–µ—Ä–Ω–æ\n\n";
//         }
//         const e = await saveUserData(ctx);
//         let message = `–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ! –†–µ–∑—É–ª—å—Ç–∞—Ç: ` + ctx.session.result + ` –±–∞–ª–ª–æ–≤.`;
//         if (ctx.session.result >= 10) {
//             message += `\n\n–ü–æ—Ç—Ä—è—Å–∞—é—â–µ ü•≥Ô∏èü•≥Ô∏èü•≥Ô∏èü•≥Ô∏èü•≥Ô∏èü•≥Ô∏èü•≥Ô∏èü•≥Ô∏è`;
//         } else if (ctx.session.result >= 7) {
//             message += `\n\n–•–æ—Ä–æ—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!`;
//         } else if (ctx.session.result < 7) {
//             message += `\n\n–í —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –æ–±—è–∑—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∏—Ç—Å—è!`;
//         }
//
//         return ctx.reply(error + message);
//     }
// });

bot.launch();
// const router = new Router();
// router.post(`/sj-talent-tg`, createTelegrafMiddleware(bot));
// new Application().use(router.middleware).listen();
